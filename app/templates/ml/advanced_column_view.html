{% extends "base.html" %}

{% block title %}Etichettatura Avanzata Colonne - {{ sheet.name }}{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col s12">
            <nav>
                <div class="nav-wrapper">
                    <div class="col s12">
                        <a href="{{ url_for('main.dashboard') }}" class="breadcrumb">Dashboard</a>
                        <a href="{{ url_for('projects.view_project', project_id=project.id) }}" class="breadcrumb">{{ project.name }}</a>
                        <a href="{{ url_for('ml.view_ml_dashboard', project_id=project.id) }}" class="breadcrumb">Machine Learning</a>
                        <span class="breadcrumb">Etichettatura Avanzata Colonne - {{ sheet.name }}</span>
                    </div>
                </div>
            </nav>
        </div>
    </div>

    <!-- Header Controls -->
    <div class="row">
        <div class="col s12">
            <div class="card">
                <div class="card-content">
                    <span class="card-title">
                        <i class="material-icons left">view_column</i>
                        Etichettatura Avanzata Colonne
                    </span>
                    <p>Seleziona una colonna e etichetta ogni cella individualmente con supporto AI avanzato.</p>
                </div>
                <div class="card-action">
                    <a href="{{ url_for('ml.advanced_row_view', project_id=project.id, sheet_id=sheet.id) }}" 
                       class="btn waves-effect waves-light blue">
                        <i class="material-icons left">view_list</i>
                        Vista Righe Avanzata
                    </a>
                    <a href="{{ url_for('ml.view_ml_dashboard', project_id=project.id) }}" 
                       class="btn waves-effect waves-light grey">
                        <i class="material-icons left">arrow_back</i>
                        Dashboard ML
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Column Selection and Progress -->
    <div class="row">
        <div class="col s12 m6">
            <div class="card">
                <div class="card-content">
                    <span class="card-title">Selezione Colonna</span>
                    <div class="input-field">
                        <select id="column-selector">
                            <option value="" disabled selected>Scegli una colonna</option>
                            {% for col_name in columns_data.keys() %}
                            <option value="{{ col_name }}">{{ col_name }}</option>
                            {% endfor %}
                        </select>
                        <label>Colonna da Etichettare</label>
                    </div>
                    <div id="column-info" style="display: none;">
                        <div class="collection">
                            <div class="collection-item">
                                <strong>Valori Unici:</strong> <span id="unique-count"></span>
                            </div>
                            <div class="collection-item">
                                <strong>Valori Nulli:</strong> <span id="null-count"></span>
                            </div>
                            <div class="collection-item">
                                <strong>Tipo Dati:</strong> <span id="data-type"></span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col s12 m6">
            <div class="card">
                <div class="card-content">
                    <span class="card-title">Progresso Etichettatura</span>
                    <div class="progress-container">
                        <div class="progress">
                            <div class="determinate" id="labeling-progress" style="width: 0%"></div>
                        </div>
                        <p class="center-align">
                            <span id="labeled-count">0</span> / <span id="total-count">0</span> celle etichettate
                            (<span id="progress-percentage">0</span>%)
                        </p>
                    </div>
                    <div class="row" style="margin-top: 20px;">
                        <div class="col s6">
                            <a href="#" class="btn waves-effect waves-light orange btn-block" id="batch-ai-label">
                                <i class="material-icons left">psychology</i>
                                Etichettatura AI Batch
                            </a>
                        </div>
                        <div class="col s6">
                            <a href="#" class="btn waves-effect waves-light green btn-block" id="export-labels">
                                <i class="material-icons left">file_download</i>
                                Esporta Etichette
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- AI Labeling Templates -->
    <div class="row" id="ai-templates-section" style="display: none;">
        <div class="col s12">
            <div class="card">
                <div class="card-content">
                    <span class="card-title">Template AI per Etichettatura</span>
                    <div class="row">
                        <div class="col s12 m6 l4">
                            <div class="card-panel hoverable ai-template" data-template="sentiment">
                                <h6><i class="material-icons left">sentiment_satisfied</i>Analisi Sentiment</h6>
                                <p>Classifica il sentiment come positivo, negativo o neutrale</p>
                                <div class="chip green">Positivo</div>
                                <div class="chip red">Negativo</div>
                                <div class="chip grey">Neutrale</div>
                            </div>
                        </div>
                        <div class="col s12 m6 l4">
                            <div class="card-panel hoverable ai-template" data-template="emotion">
                                <h6><i class="material-icons left">mood</i>Rilevamento Emozioni</h6>
                                <p>Identifica emozioni specifiche nel testo</p>
                                <div class="chip yellow">Gioia</div>
                                <div class="chip red">Rabbia</div>
                                <div class="chip blue">Tristezza</div>
                                <div class="chip purple">Paura</div>
                            </div>
                        </div>
                        <div class="col s12 m6 l4">
                            <div class="card-panel hoverable ai-template" data-template="behavior">
                                <h6><i class="material-icons left">psychology</i>Classificazione Comportamentale</h6>
                                <p>Classifica il comportamento espresso</p>
                                <div class="chip orange">Aggressivo</div>
                                <div class="chip blue">Passivo</div>
                                <div class="chip green">Assertivo</div>
                            </div>
                        </div>
                        <div class="col s12 m6 l4">
                            <div class="card-panel hoverable ai-template" data-template="topic">
                                <h6><i class="material-icons left">topic</i>Categorizzazione Argomenti</h6>
                                <p>Identifica l'argomento principale del contenuto</p>
                                <div class="chip teal">Tecnologia</div>
                                <div class="chip indigo">Business</div>
                                <div class="chip pink">Personale</div>
                            </div>
                        </div>
                        <div class="col s12 m6 l4">
                            <div class="card-panel hoverable ai-template" data-template="intent">
                                <h6><i class="material-icons left">track_changes</i>Classificazione Intenti</h6>
                                <p>Determina l'intento dell'utente</p>
                                <div class="chip cyan">Richiesta</div>
                                <div class="chip amber">Reclamo</div>
                                <div class="chip lime">Complimento</div>
                            </div>
                        </div>
                        <div class="col s12 m6 l4">
                            <div class="card-panel hoverable ai-template" data-template="custom">
                                <h6><i class="material-icons left">edit</i>Categoria Personalizzata</h6>
                                <p>Definisci le tue categorie personalizzate</p>
                                <div class="chip grey">Personalizzabile</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Cell Labeling Interface -->
    <div class="row" id="labeling-interface" style="display: none;">
        <div class="col s12 m8">
            <div class="card">
                <div class="card-content">
                    <span class="card-title">Etichettatura Celle</span>
                    <div id="cells-container">
                        <!-- Le celle verranno caricate dinamicamente qui -->
                    </div>
                    <div class="center-align" style="margin-top: 20px;">
                        <a href="#" class="btn waves-effect waves-light blue" id="prev-cell" disabled>
                            <i class="material-icons left">chevron_left</i>
                            Precedente
                        </a>
                        <span id="cell-counter" style="margin: 0 20px;">1 / 1</span>
                        <a href="#" class="btn waves-effect waves-light blue" id="next-cell">
                            <i class="material-icons left">chevron_right</i>
                            Successiva
                        </a>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col s12 m4">
            <div class="card">
                <div class="card-content">
                    <span class="card-title">Pannello Etichettatura</span>
                    <div id="current-cell-info">
                        <div class="card-panel grey lighten-4">
                            <p><strong>Posizione:</strong> Riga <span id="current-row">-</span></p>
                            <p><strong>Colonna:</strong> <span id="current-column">-</span></p>
                            <p><strong>Valore:</strong></p>
                            <div class="cell-value-display" id="current-value">Seleziona una cella</div>
                        </div>
                    </div>
                    
                    <!-- Manual Labeling -->
                    <div class="section">
                        <h6>Etichettatura Manuale</h6>
                        <div class="input-field">
                            <input id="manual-label" type="text" placeholder="Nome etichetta">
                            <label for="manual-label">Etichetta</label>
                        </div>
                        <div class="input-field">
                            <textarea id="manual-description" class="materialize-textarea" placeholder="Descrizione opzionale"></textarea>
                            <label for="manual-description">Descrizione</label>
                        </div>
                        <a href="#" class="btn waves-effect waves-light green btn-block" id="save-manual-label">
                            <i class="material-icons left">save</i>
                            Salva Etichetta
                        </a>
                    </div>
                    
                    <!-- AI Suggestions -->
                    <div class="section">
                        <h6>Suggerimenti AI</h6>
                        <div id="ai-suggestions" style="display: none;">
                            <div class="collection" id="suggestions-list">
                                <!-- I suggerimenti AI verranno caricati qui -->
                            </div>
                        </div>
                        <a href="#" class="btn waves-effect waves-light orange btn-block" id="get-ai-suggestions">
                            <i class="material-icons left">psychology</i>
                            Ottieni Suggerimenti AI
                        </a>
                    </div>
                    
                    <!-- Quality Control -->
                    <div class="section">
                        <h6>Controllo Qualità</h6>
                        <div class="switch">
                            <label>
                                Validazione Automatica
                                <input type="checkbox" id="auto-validation">
                                <span class="lever"></span>
                            </label>
                        </div>
                        <div class="confidence-display" style="margin-top: 10px; display: none;">
                            <p>Confidenza AI: <span id="confidence-score">-</span>%</p>
                            <div class="progress">
                                <div class="determinate" id="confidence-bar" style="width: 0%"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal per Batch AI Labeling -->
<div id="batch-ai-modal" class="modal modal-fixed-footer">
    <div class="modal-content">
        <h4>Etichettatura AI Batch</h4>
        <p>Seleziona un template AI per etichettare automaticamente tutte le celle della colonna selezionata.</p>
        
        <div class="row">
            <div class="col s12">
                <div class="input-field">
                    <select id="batch-template-selector">
                        <option value="" disabled selected>Scegli un template</option>
                        <option value="sentiment">Analisi Sentiment</option>
                        <option value="emotion">Rilevamento Emozioni</option>
                        <option value="behavior">Classificazione Comportamentale</option>
                        <option value="topic">Categorizzazione Argomenti</option>
                        <option value="intent">Classificazione Intenti</option>
                        <option value="custom">Categoria Personalizzata</option>
                    </select>
                    <label>Template AI</label>
                </div>
            </div>
        </div>
        
        <div id="custom-categories" style="display: none;">
            <div class="row">
                <div class="col s12">
                    <div class="input-field">
                        <textarea id="custom-categories-input" class="materialize-textarea" placeholder="Inserisci le categorie separate da virgola (es: Categoria1, Categoria2, Categoria3)"></textarea>
                        <label for="custom-categories-input">Categorie Personalizzate</label>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="row">
            <div class="col s12">
                <div class="switch">
                    <label>
                        Solo celle non etichettate
                        <input type="checkbox" id="only-unlabeled" checked>
                        <span class="lever"></span>
                    </label>
                </div>
            </div>
        </div>
        
        <div id="batch-progress" style="display: none;">
            <div class="progress">
                <div class="determinate" id="batch-progress-bar" style="width: 0%"></div>
            </div>
            <p class="center-align">
                Processando: <span id="batch-current">0</span> / <span id="batch-total">0</span>
            </p>
        </div>
    </div>
    <div class="modal-footer">
        <a href="#!" class="modal-close waves-effect waves-green btn-flat">Annulla</a>
        <a href="#!" class="waves-effect waves-green btn" id="start-batch-labeling">
            <i class="material-icons left">play_arrow</i>
            Avvia Etichettatura
        </a>
    </div>
</div>

<style>
.ai-template {
    cursor: pointer;
    transition: all 0.3s;
    border-left: 4px solid transparent;
}

.ai-template:hover {
    border-left-color: #2196f3;
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.2);
}

.ai-template.selected {
    border-left-color: #4caf50;
    background-color: #e8f5e8;
}

.cell-value-display {
    background: #f5f5f5;
    padding: 10px;
    border-radius: 4px;
    min-height: 60px;
    word-wrap: break-word;
    border: 1px solid #ddd;
}

.btn-block {
    width: 100%;
    margin-bottom: 10px;
}

.section {
    margin: 20px 0;
    padding: 15px 0;
    border-bottom: 1px solid #e0e0e0;
}

.section:last-child {
    border-bottom: none;
}

.suggestions-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 10px;
    border: 1px solid #e0e0e0;
    border-radius: 4px;
    margin: 5px 0;
    cursor: pointer;
    transition: background-color 0.3s;
}

.suggestions-item:hover {
    background-color: #f5f5f5;
}

.confidence-badge {
    font-size: 0.8em;
    padding: 2px 8px;
    border-radius: 12px;
    color: white;
}

.confidence-high { background-color: #4caf50; }
.confidence-medium { background-color: #ff9800; }
.confidence-low { background-color: #f44336; }
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Inizializza componenti Materialize
    M.FormSelect.init(document.querySelectorAll('select'));
    M.Modal.init(document.querySelectorAll('.modal'));
    M.updateTextFields();
    
    // Dati globali
    let currentColumn = null;
    let columnData = {{ columns_data | tojsonfilter }};
    let currentCellIndex = 0;
    let currentCells = [];
    
    // Gestione selezione colonna
    document.getElementById('column-selector').addEventListener('change', function() {
        currentColumn = this.value;
        if (currentColumn && columnData[currentColumn]) {
            loadColumnData();
            showLabelingInterface();
        }
    });
    
    function loadColumnData() {
        const data = columnData[currentColumn];
        
        // Aggiorna info colonna
        document.getElementById('unique-count').textContent = data.unique_values;
        document.getElementById('null-count').textContent = data.null_count;
        document.getElementById('data-type').textContent = data.type;
        document.getElementById('column-info').style.display = 'block';
        
        // Carica celle (simula dati per ora)
        currentCells = Array.from({length: Math.min(data.unique_values, 100)}, (_, index) => ({
            row: index,
            value: data.sample_values[index % data.sample_values.length] || `Valore ${index + 1}`,
            labeled: false,
            label: null,
            confidence: null
        }));
        
        // Aggiorna contatori
        document.getElementById('total-count').textContent = currentCells.length;
        updateProgress();
        
        // Mostra template AI
        document.getElementById('ai-templates-section').style.display = 'block';
    }
    
    function showLabelingInterface() {
        document.getElementById('labeling-interface').style.display = 'block';
        currentCellIndex = 0;
        displayCurrentCell();
    }
    
    function displayCurrentCell() {
        if (currentCells.length === 0) return;
        
        const cell = currentCells[currentCellIndex];
        
        // Aggiorna info cella corrente
        document.getElementById('current-row').textContent = cell.row + 1;
        document.getElementById('current-column').textContent = currentColumn;
        document.getElementById('current-value').textContent = cell.value || '(vuoto)';
        
        // Aggiorna contatore
        document.getElementById('cell-counter').textContent = `${currentCellIndex + 1} / ${currentCells.length}`;
        
        // Aggiorna pulsanti navigazione
        document.getElementById('prev-cell').classList.toggle('disabled', currentCellIndex === 0);
        document.getElementById('next-cell').classList.toggle('disabled', currentCellIndex === currentCells.length - 1);
        
        // Se la cella è già etichettata, mostra l'etichetta
        if (cell.labeled) {
            document.getElementById('manual-label').value = cell.label;
            document.getElementById('manual-description').value = cell.description || '';
            M.updateTextFields();
            
            if (cell.confidence) {
                showConfidence(cell.confidence);
            }
        } else {
            document.getElementById('manual-label').value = '';
            document.getElementById('manual-description').value = '';
            M.updateTextFields();
            hideConfidence();
        }
        
        // Nascondi suggerimenti AI precedenti
        document.getElementById('ai-suggestions').style.display = 'none';
    }
    
    function updateProgress() {
        const labeled = currentCells.filter(cell => cell.labeled).length;
        const total = currentCells.length;
        const percentage = total > 0 ? Math.round((labeled / total) * 100) : 0;
        
        document.getElementById('labeled-count').textContent = labeled;
        document.getElementById('progress-percentage').textContent = percentage;
        document.getElementById('labeling-progress').style.width = percentage + '%';
    }
    
    function showConfidence(confidence) {
        document.getElementById('confidence-score').textContent = Math.round(confidence * 100);
        document.getElementById('confidence-bar').style.width = (confidence * 100) + '%';
        document.querySelector('.confidence-display').style.display = 'block';
        
        // Colora la barra in base alla confidenza
        const bar = document.getElementById('confidence-bar');
        if (confidence >= 0.8) {
            bar.className = 'determinate green';
        } else if (confidence >= 0.6) {
            bar.className = 'determinate orange';
        } else {
            bar.className = 'determinate red';
        }
    }
    
    function hideConfidence() {
        document.querySelector('.confidence-display').style.display = 'none';
    }
    
    // Navigazione celle
    document.getElementById('prev-cell').addEventListener('click', function(e) {
        e.preventDefault();
        if (currentCellIndex > 0) {
            currentCellIndex--;
            displayCurrentCell();
        }
    });
    
    document.getElementById('next-cell').addEventListener('click', function(e) {
        e.preventDefault();
        if (currentCellIndex < currentCells.length - 1) {
            currentCellIndex++;
            displayCurrentCell();
        }
    });
    
    // Salvataggio etichetta manuale
    document.getElementById('save-manual-label').addEventListener('click', function(e) {
        e.preventDefault();
        
        const label = document.getElementById('manual-label').value.trim();
        const description = document.getElementById('manual-description').value.trim();
        
        if (!label) {
            M.toast({html: 'Inserisci un nome per l\'etichetta', classes: 'red'});
            return;
        }
        
        saveCellLabel(currentCellIndex, label, description, 1.0, 'manual');
    });
    
    function saveCellLabel(cellIndex, label, description, confidence, source) {
        const cell = currentCells[cellIndex];
        
        const data = {
            row_index: cell.row,
            column_name: currentColumn,
            label_name: label,
            label_description: description
        };
        
        fetch('{{ url_for("ml.label_cell_manually", project_id=project.id, sheet_id=sheet.id) }}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(data)
        })
        .then(response => response.json())
        .then(data => {
            if (data.message) {
                // Aggiorna stato cella
                cell.labeled = true;
                cell.label = label;
                cell.description = description;
                cell.confidence = confidence;
                cell.source = source;
                
                updateProgress();
                M.toast({html: `Etichetta salvata: ${label}`, classes: 'green'});
                
                // Vai alla prossima cella non etichettata
                goToNextUnlabeled();
            } else {
                M.toast({html: data.error || 'Errore nel salvataggio', classes: 'red'});
            }
        })
        .catch(error => {
            M.toast({html: 'Errore di rete: ' + error.message, classes: 'red'});
        });
    }
    
    function goToNextUnlabeled() {
        for (let i = currentCellIndex + 1; i < currentCells.length; i++) {
            if (!currentCells[i].labeled) {
                currentCellIndex = i;
                displayCurrentCell();
                return;
            }
        }
        
        // Se non ci sono più celle non etichettate dopo la corrente, cerca dall'inizio
        for (let i = 0; i < currentCellIndex; i++) {
            if (!currentCells[i].labeled) {
                currentCellIndex = i;
                displayCurrentCell();
                return;
            }
        }
        
        // Tutte le celle sono etichettate
        M.toast({html: 'Tutte le celle sono state etichettate!', classes: 'green'});
    }
    
    // Suggerimenti AI
    document.getElementById('get-ai-suggestions').addEventListener('click', function(e) {
        e.preventDefault();
        getAISuggestions();
    });
    
    function getAISuggestions() {
        const cell = currentCells[currentCellIndex];
        const suggestionsContainer = document.getElementById('suggestions-list');
        
        // Mostra loading
        suggestionsContainer.innerHTML = '<div class="center-align"><div class="preloader-wrapper small active"><div class="spinner-layer spinner-blue-only"><div class="circle-clipper left"><div class="circle"></div></div><div class="gap-patch"><div class="circle"></div></div><div class="circle-clipper right"><div class="circle"></div></div></div></div></div>';
        document.getElementById('ai-suggestions').style.display = 'block';
        
        // Simula chiamata AI
        setTimeout(() => {
            const suggestions = generateAISuggestions(cell.value);
            displaySuggestions(suggestions);
        }, 2000);
    }
    
    function generateAISuggestions(cellValue) {
        const suggestions = [];
        const value = (cellValue || '').toLowerCase();
        
        // Sentiment Analysis
        if (value.includes('buon') || value.includes('ottim') || value.includes('eccell')) {
            suggestions.push({label: 'Sentiment Positivo', confidence: 0.85, category: 'sentiment'});
        } else if (value.includes('cattiv') || value.includes('pessim') || value.includes('terrib')) {
            suggestions.push({label: 'Sentiment Negativo', confidence: 0.82, category: 'sentiment'});
        } else {
            suggestions.push({label: 'Sentiment Neutrale', confidence: 0.65, category: 'sentiment'});
        }
        
        // Emotion Detection
        if (value.includes('felice') || value.includes('gioi')) {
            suggestions.push({label: 'Gioia', confidence: 0.78, category: 'emotion'});
        } else if (value.includes('arrabbia') || value.includes('rabbia')) {
            suggestions.push({label: 'Rabbia', confidence: 0.80, category: 'emotion'});
        }
        
        // Topic Classification
        if (value.includes('tecnolog') || value.includes('software') || value.includes('computer')) {
            suggestions.push({label: 'Tecnologia', confidence: 0.75, category: 'topic'});
        } else if (value.includes('business') || value.includes('lavoro') || value.includes('aziend')) {
            suggestions.push({label: 'Business', confidence: 0.72, category: 'topic'});
        }
        
        return suggestions;
    }
    
    function displaySuggestions(suggestions) {
        const container = document.getElementById('suggestions-list');
        
        if (suggestions.length === 0) {
            container.innerHTML = '<div class="center-align grey-text">Nessun suggerimento disponibile</div>';
            return;
        }
        
        container.innerHTML = suggestions.map(suggestion => {
            const confidenceClass = suggestion.confidence >= 0.8 ? 'confidence-high' : 
                                  suggestion.confidence >= 0.6 ? 'confidence-medium' : 'confidence-low';
            
            return `
                <div class="suggestions-item" data-label="${suggestion.label}" data-confidence="${suggestion.confidence}">
                    <div>
                        <strong>${suggestion.label}</strong>
                        <br><small class="grey-text">${suggestion.category}</small>
                    </div>
                    <span class="confidence-badge ${confidenceClass}">${Math.round(suggestion.confidence * 100)}%</span>
                </div>
            `;
        }).join('');
        
        // Aggiungi event listeners ai suggerimenti
        container.querySelectorAll('.suggestions-item').forEach(item => {
            item.addEventListener('click', function() {
                const label = this.dataset.label;
                const confidence = parseFloat(this.dataset.confidence);
                
                document.getElementById('manual-label').value = label;
                M.updateTextFields();
                showConfidence(confidence);
                
                M.toast({html: `Suggerimento applicato: ${label}`, classes: 'blue'});
            });
        });
    }
    
    // Export Labels
    document.getElementById('export-labels').addEventListener('click', function(e) {
        e.preventDefault();
        
        if (!currentColumn) {
            M.toast({html: 'Seleziona prima una colonna', classes: 'red'});
            return;
        }
        
        const labeledCells = currentCells.filter(cell => cell.labeled);
        
        if (labeledCells.length === 0) {
            M.toast({html: 'Nessuna etichetta da esportare', classes: 'orange'});
            return;
        }
        
        // Crea CSV
        const csvContent = [
            ['Riga', 'Colonna', 'Valore', 'Etichetta', 'Descrizione', 'Confidenza', 'Fonte'],
            ...labeledCells.map(cell => [
                cell.row + 1,
                currentColumn,
                cell.value || '',
                cell.label || '',
                cell.description || '',
                cell.confidence || '',
                cell.source || ''
            ])
        ].map(row => row.map(field => `"${field}"`).join(',')).join('\n');
        
        // Download
        const blob = new Blob([csvContent], { type: 'text/csv' });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `etichette_${currentColumn}_${new Date().toISOString().split('T')[0]}.csv`;
        a.click();
        window.URL.revokeObjectURL(url);
        
        M.toast({html: 'Etichette esportate con successo!', classes: 'green'});
    });
    
    // Batch AI Labeling
    document.getElementById('batch-ai-label').addEventListener('click', function(e) {
        e.preventDefault();
        if (!currentColumn) {
            M.toast({html: 'Seleziona prima una colonna', classes: 'red'});
            return;
        }
        
        const modal = M.Modal.getInstance(document.getElementById('batch-ai-modal'));
        modal.open();
    });
    
    document.getElementById('batch-template-selector').addEventListener('change', function() {
        const customDiv = document.getElementById('custom-categories');
        customDiv.style.display = this.value === 'custom' ? 'block' : 'none';
    });
    
    document.getElementById('start-batch-labeling').addEventListener('click', function() {
        const template = document.getElementById('batch-template-selector').value;
        const onlyUnlabeled = document.getElementById('only-unlabeled').checked;
        
        if (!template) {
            M.toast({html: 'Seleziona un template', classes: 'red'});
            return;
        }
        
        startBatchLabeling(template, onlyUnlabeled);
    });
    
    function startBatchLabeling(template, onlyUnlabeled) {
        const cellsToProcess = onlyUnlabeled ?
            currentCells.filter(cell => !cell.labeled) :
            currentCells;
        
        if (cellsToProcess.length === 0) {
            M.toast({html: 'Nessuna cella da processare', classes: 'orange'});
            return;
        }
        
        // Mostra progress
        document.getElementById('batch-progress').style.display = 'block';
        document.getElementById('batch-total').textContent = cellsToProcess.length;
        document.getElementById('start-batch-labeling').classList.add('disabled');
        
        let processed = 0;
        
        // Processa celle una alla volta
        function processNextCell() {
            if (processed >= cellsToProcess.length) {
                // Completato
                document.getElementById('batch-progress').style.display = 'none';
                document.getElementById('start-batch-labeling').classList.remove('disabled');
                M.toast({html: `Etichettatura batch completata! ${processed} celle processate.`, classes: 'green'});
                
                const modal = M.Modal.getInstance(document.getElementById('batch-ai-modal'));
                modal.close();
                
                updateProgress();
                displayCurrentCell();
                return;
            }
            
            const cell = cellsToProcess[processed];
            
            // Simula elaborazione AI
            setTimeout(() => {
                const aiLabel = generateAILabel(cell.value, template);
                
                if (aiLabel) {
                    // Aggiorna stato cella localmente per il batch
                    cell.labeled = true;
                    cell.label = aiLabel.label;
                    cell.description = aiLabel.description;
                    cell.confidence = aiLabel.confidence;
                    cell.source = 'ai_batch';
                }
                
                processed++;
                document.getElementById('batch-current').textContent = processed;
                document.getElementById('batch-progress-bar').style.width = ((processed / cellsToProcess.length) * 100) + '%';
                
                processNextCell();
            }, 300); // Simula tempo di elaborazione
        }
        
        processNextCell();
    }
    
    function generateAILabel(value, template) {
        const val = (value || '').toLowerCase();
        
        switch (template) {
            case 'sentiment':
                if (val.includes('buon') || val.includes('ottim') || val.includes('eccell')) {
                    return {label: 'Positivo', description: 'Sentiment positivo rilevato', confidence: 0.85};
                } else if (val.includes('cattiv') || val.includes('pessim') || val.includes('terrib')) {
                    return {label: 'Negativo', description: 'Sentiment negativo rilevato', confidence: 0.82};
                } else {
                    return {label: 'Neutrale', description: 'Sentiment neutrale', confidence: 0.65};
                }
                
            case 'emotion':
                if (val.includes('felice') || val.includes('gioi')) {
                    return {label: 'Gioia', description: 'Emozione di gioia rilevata', confidence: 0.78};
                } else if (val.includes('triste') || val.includes('depress')) {
                    return {label: 'Tristezza', description: 'Emozione di tristezza rilevata', confidence: 0.75};
                } else {
                    return {label: 'Neutrale', description: 'Emozione neutra', confidence: 0.60};
                }
                
            case 'topic':
                if (val.includes('tecnolog') || val.includes('software')) {
                    return {label: 'Tecnologia', description: 'Argomento tecnologico', confidence: 0.80};
                } else if (val.includes('business') || val.includes('lavoro')) {
                    return {label: 'Business', description: 'Argomento business', confidence: 0.75};
                } else {
                    return {label: 'Generale', description: 'Argomento generale', confidence: 0.50};
                }
                
            default:
                return {label: 'Classificato', description: 'Classificazione automatica', confidence: 0.70};
        }
    }
    
    // Template AI selection
    document.querySelectorAll('.ai-template').forEach(template => {
        template.addEventListener('click', function() {
            // Rimuovi selezione precedente
            document.querySelectorAll('.ai-template').forEach(t => t.classList.remove('selected'));
            this.classList.add('selected');
            
            const templateType = this.dataset.template;
            M.toast({html: `Template selezionato: ${templateType}`, classes: 'blue'});
        });
    });
});
</script>
{% endblock %}