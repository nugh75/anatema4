{% extends "base.html" %}

{% block title %}Dashboard Machine Learning - {{ project.name }}{% endblock %}

{% block content %}
<div class="container">
    <div class="row">
        <div class="col s12">
            <nav>
                <div class="nav-wrapper">
                    <div class="col s12">
                        <a href="{{ url_for('main.dashboard') }}" class="breadcrumb">Dashboard</a>
                        <a href="{{ url_for('projects.view_project', project_id=project.id) }}" class="breadcrumb">{{ project.name }}</a>
                        <span class="breadcrumb">Machine Learning</span>
                    </div>
                </div>
            </nav>
        </div>
    </div>

    <div class="row">
        <div class="col s12">
            <div class="card">
                <div class="card-content">
                    <span class="card-title">
                        <i class="material-icons left">psychology</i>
                        Dashboard Machine Learning
                    </span>
                    <p>Analisi automatica e etichettatura intelligente dei dati del progetto.</p>
                </div>
                <div class="card-action">
                    <a href="{{ url_for('ml.configure_ml', project_id=project.id) }}" class="btn waves-effect waves-light blue">
                        <i class="material-icons left">settings</i>
                        Configura ML
                    </a>
                    {% if ml_config %}
                    <a href="#" class="btn waves-effect waves-light green" id="start-analysis-btn">
                        <i class="material-icons left">play_arrow</i>
                        Avvia Analisi
                    </a>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    {% if ml_config %}
    <!-- Configurazione Attuale -->
    <div class="row">
        <div class="col s12 l6">
            <div class="card">
                <div class="card-content">
                    <span class="card-title">Configurazione Attuale</span>
                    <div class="collection">
                        <div class="collection-item">
                            <strong>Nome:</strong> {{ ml_config.name }}
                        </div>
                        <div class="collection-item">
                            <strong>Provider:</strong> 
                            <span class="chip {{ 'green' if ml_config.ml_provider == 'ollama' else 'blue' }} white-text">
                                {{ ml_config.ml_provider.upper() }}
                            </span>
                        </div>
                        <div class="collection-item">
                            <strong>Modello:</strong> {{ ml_config.ml_model }}
                        </div>
                        <div class="collection-item">
                            <strong>Ultima modifica:</strong> {{ ml_config.updated_at.strftime('%d/%m/%Y %H:%M') }}
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Statistiche -->
        <div class="col s12 l6">
            <div class="card">
                <div class="card-content">
                    <span class="card-title">Statistiche</span>
                    <div class="row">
                        <div class="col s6">
                            <div class="center-align">
                                <h4 class="blue-text">{{ stats.total_analyses }}</h4>
                                <p>Analisi Totali</p>
                            </div>
                        </div>
                        <div class="col s6">
                            <div class="center-align">
                                <h4 class="green-text">{{ stats.auto_labels_generated }}</h4>
                                <p>Etichette Generate</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Fogli Disponibili -->
    <div class="row">
        <div class="col s12">
            <div class="card">
                <div class="card-content">
                    <span class="card-title">
                        <i class="material-icons left">table_chart</i>
                        Fogli Disponibili per Analisi
                    </span>
                    
                    {% if sheets %}
                    <div class="collection">
                        {% for sheet in sheets %}
                        <div class="collection-item">
                            <div class="row valign-wrapper">
                                <div class="col s8">
                                    <h6>{{ sheet.name }}</h6>
                                    <p class="grey-text">
                                        File: {{ sheet.file.filename }}<br>
                                        Righe: {{ sheet.row_count }} | Colonne: {{ sheet.column_count }}
                                    </p>
                                </div>
                                <div class="col s4 right-align">
                                    {% set analysis = sheet.ml_analyses[0] if sheet.ml_analyses else None %}
                                    {% if analysis %}
                                    <span class="chip green white-text">Analizzato</span>
                                    <br><br>
                                    <a href="{{ url_for('ml.view_analysis_results', project_id=project.id, analysis_id=analysis.id) }}"
                                       class="btn waves-effect waves-light blue">
                                        <i class="material-icons left">visibility</i>
                                        Visualizza
                                    </a>
                                    {% endif %}
                                    <a href="#" class="btn waves-effect waves-light orange analyze-sheet-btn"
                                       data-sheet-id="{{ sheet.id }}">
                                        <i class="material-icons left">analytics</i>
                                        {{ 'Ri-analizza' if analysis else 'Analizza' }}
                                    </a>
                                    <br><br>
                                    <!-- Viste Base -->
                                    <div class="row" style="margin-bottom: 5px;">
                                        <div class="col s6">
                                            <a href="{{ url_for('ml.single_column_view', project_id=project.id, sheet_id=sheet.id) }}"
                                               class="btn waves-effect waves-light teal btn-small" style="width: 100%;">
                                                <i class="material-icons left">view_column</i>
                                                Vista Colonne
                                            </a>
                                        </div>
                                        <div class="col s6">
                                            <a href="{{ url_for('ml.single_row_view', project_id=project.id, sheet_id=sheet.id) }}"
                                               class="btn waves-effect waves-light purple btn-small" style="width: 100%;">
                                                <i class="material-icons left">view_list</i>
                                                Vista Righe
                                            </a>
                                        </div>
                                    </div>
                                    <!-- Viste Avanzate -->
                                    <div class="row" style="margin-bottom: 0;">
                                        <div class="col s6">
                                            <a href="{{ url_for('ml.advanced_column_view', project_id=project.id, sheet_id=sheet.id) }}"
                                               class="btn waves-effect waves-light deep-orange btn-small" style="width: 100%;">
                                                <i class="material-icons left">smart_toy</i>
                                                AI Colonne
                                            </a>
                                        </div>
                                        <div class="col s6">
                                            <a href="{{ url_for('ml.advanced_row_view', project_id=project.id, sheet_id=sheet.id) }}"
                                               class="btn waves-effect waves-light indigo btn-small" style="width: 100%;">
                                                <i class="material-icons left">psychology</i>
                                                AI Righe
                                            </a>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    {% else %}
                    <div class="center-align">
                        <i class="material-icons large grey-text">table_chart</i>
                        <p class="grey-text">Nessun foglio disponibile per l'analisi.</p>
                        <a href="{{ url_for('projects.view_project', project_id=project.id) }}" class="btn waves-effect waves-light">
                            Carica File Excel
                        </a>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Analisi Recenti -->
    {% if recent_analyses %}
    <div class="row">
        <div class="col s12">
            <div class="card">
                <div class="card-content">
                    <span class="card-title">
                        <i class="material-icons left">history</i>
                        Analisi Recenti
                    </span>
                    
                    <div class="collection">
                        {% for analysis in recent_analyses %}
                        <div class="collection-item">
                            <div class="row valign-wrapper">
                                <div class="col s8">
                                    <h6>{{ analysis.sheet.name }}</h6>
                                    <p class="grey-text">
                                        Avviata: {{ analysis.created_at.strftime('%d/%m/%Y %H:%M') }}<br>
                                        Stato: 
                                        <span class="chip {{ 'green' if analysis.status == 'completed' else 'orange' if analysis.status == 'running' else 'red' }} white-text">
                                            {{ analysis.status.upper() }}
                                        </span>
                                        {% if analysis.status == 'completed' %}
                                        <br>Colonne analizzate: {{ analysis.column_analyses.count() }}
                                        <br>Etichette generate: {{ analysis.auto_labels.count() }}
                                        {% endif %}
                                    </p>
                                </div>
                                <div class="col s4 right-align">
                                    {% if analysis.status == 'completed' %}
                                    <a href="{{ url_for('ml.view_analysis_results', project_id=project.id, analysis_id=analysis.id) }}"
                                       class="btn waves-effect waves-light blue">
                                        <i class="material-icons left">visibility</i>
                                        Visualizza
                                    </a>
                                    {% elif analysis.status == 'running' %}
                                    <div class="preloader-wrapper small active">
                                        <div class="spinner-layer spinner-blue-only">
                                            <div class="circle-clipper left">
                                                <div class="circle"></div>
                                            </div>
                                            <div class="gap-patch">
                                                <div class="circle"></div>
                                            </div>
                                            <div class="circle-clipper right">
                                                <div class="circle"></div>
                                            </div>
                                        </div>
                                    </div>
                                    {% else %}
                                    <span class="red-text">
                                        <i class="material-icons">error</i>
                                        Errore
                                    </span>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    {% else %}
    <!-- Nessuna Configurazione -->
    <div class="row">
        <div class="col s12">
            <div class="card">
                <div class="card-content center-align">
                    <i class="material-icons large grey-text">settings</i>
                    <h5 class="grey-text">Configurazione ML Richiesta</h5>
                    <p class="grey-text">Prima di iniziare l'analisi automatica, è necessario configurare le impostazioni del machine learning.</p>
                    <br>
                    <a href="{{ url_for('ml.configure_ml', project_id=project.id) }}" class="btn waves-effect waves-light blue large">
                        <i class="material-icons left">settings</i>
                        Configura Ora
                    </a>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
</div>

<!-- Modal per Progresso Analisi -->
<div id="analysis-progress-modal" class="modal">
    <div class="modal-content">
        <h4>Analisi in Corso</h4>
        <div class="progress">
            <div class="indeterminate"></div>
        </div>
        <p id="analysis-status">Inizializzazione analisi...</p>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Inizializza modal
    M.Modal.init(document.querySelectorAll('.modal'));
    
    // Gestisci analisi singolo foglio
    document.querySelectorAll('.analyze-sheet-btn').forEach(btn => {
        btn.addEventListener('click', function(e) {
            e.preventDefault();
            const sheetId = this.dataset.sheetId;
            startAnalysis([sheetId]);
        });
    });
    
    // Gestisci analisi completa
    const startAnalysisBtn = document.getElementById('start-analysis-btn');
    if (startAnalysisBtn) {
        startAnalysisBtn.addEventListener('click', function(e) {
            e.preventDefault();
            const sheetIds = Array.from(document.querySelectorAll('.analyze-sheet-btn'))
                                 .map(btn => btn.dataset.sheetId);
            startAnalysis(sheetIds);
        });
    }
    
    function startAnalysis(sheetIds) {
        const modal = M.Modal.getInstance(document.getElementById('analysis-progress-modal'));
        const statusElement = document.getElementById('analysis-status');
        
        modal.open();
        statusElement.textContent = 'Avvio analisi...';
        
        // Per ora, analizziamo i fogli uno per uno
        analyzeSheets(sheetIds);
    }
    
    function analyzeSheets(sheetIds) {
        const modal = M.Modal.getInstance(document.getElementById('analysis-progress-modal'));
        const statusElement = document.getElementById('analysis-status');
        
        if (sheetIds.length === 0) {
            statusElement.textContent = 'Nessun foglio da analizzare';
            setTimeout(() => modal.close(), 2000);
            return;
        }
        
        let currentIndex = 0;
        
        function analyzeNext() {
            if (currentIndex >= sheetIds.length) {
                statusElement.textContent = 'Tutte le analisi completate!';
                setTimeout(() => {
                    modal.close();
                    location.reload();
                }, 2000);
                return;
            }
            
            const sheetId = sheetIds[currentIndex];
            statusElement.textContent = `Analizzando foglio ${currentIndex + 1} di ${sheetIds.length}...`;
            
            fetch(`{{ url_for("ml.analyze_sheet", project_id=project.id, sheet_id="SHEET_ID") }}`.replace('SHEET_ID', sheetId), {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.message) {
                    currentIndex++;
                    analyzeNext();
                } else {
                    statusElement.textContent = `Errore nell'analisi del foglio ${currentIndex + 1}`;
                    setTimeout(() => modal.close(), 3000);
                }
            })
            .catch(error => {
                statusElement.textContent = `Errore: ${error.message}`;
                setTimeout(() => modal.close(), 3000);
            });
        }
        
        analyzeNext();
    }
    
    // Auto-refresh per analisi in corso
    const runningAnalyses = document.querySelectorAll('.chip:contains("RUNNING")');
    if (runningAnalyses.length > 0) {
        setTimeout(() => {
            location.reload();
        }, 10000); // Ricarica ogni 10 secondi
    }
});
</script>
{% endblock %}