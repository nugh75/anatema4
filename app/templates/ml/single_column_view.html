{% extends "base.html" %}

{% block title %}Vista Colonna: {{ selected_column }} - {{ sheet.name }}{% endblock %}

{% block content %}
<div class="container">
    <div class="row">
        <div class="col s12">
            <nav>
                <div class="nav-wrapper">
                    <div class="col s12">
                        <a href="{{ url_for('main.dashboard') }}" class="breadcrumb">Dashboard</a>
                        <a href="{{ url_for('projects.view_project', project_id=project.id) }}" class="breadcrumb">{{ project.name }}</a>
                        <a href="{{ url_for('ml.view_ml_dashboard', project_id=project.id) }}" class="breadcrumb">Machine Learning</a>
                        <span class="breadcrumb">Vista Colonna: {{ selected_column }}</span>
                    </div>
                </div>
            </nav>
        </div>
    </div>

    <!-- Header con informazioni colonna -->
    <div class="row">
        <div class="col s12">
            <div class="card">
                <div class="card-content">
                    <span class="card-title">
                        <i class="material-icons left">view_column</i>
                        Colonna: {{ selected_column }}
                    </span>
                    <p>Etichetta i valori di questa colonna uno per uno. Ogni cella può essere etichettata manualmente o con suggerimenti AI.</p>
                    
                    <div class="row" style="margin-top: 20px;">
                        <div class="col s3">
                            <div class="center-align">
                                <h6 class="blue-text">{{ column_data.total_rows }}</h6>
                                <p class="grey-text">Totale Righe</p>
                            </div>
                        </div>
                        <div class="col s3">
                            <div class="center-align">
                                <h6 class="green-text">{{ column_data.unique_values }}</h6>
                                <p class="grey-text">Valori Unici</p>
                            </div>
                        </div>
                        <div class="col s3">
                            <div class="center-align">
                                <h6 class="orange-text">{{ column_data.null_count }}</h6>
                                <p class="grey-text">Valori Nulli</p>
                            </div>
                        </div>
                        <div class="col s3">
                            <div class="center-align">
                                <h6 class="purple-text">{{ applied_labels|length }}</h6>
                                <p class="grey-text">Etichettate</p>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="card-action">
                    <a href="{{ url_for('ml.single_column_view', project_id=project.id, sheet_id=sheet.id) }}" 
                       class="btn waves-effect waves-light blue">
                        <i class="material-icons left">list</i>
                        Cambia Colonna
                    </a>
                    <a href="{{ url_for('ml.single_row_view', project_id=project.id, sheet_id=sheet.id) }}" 
                       class="btn waves-effect waves-light green">
                        <i class="material-icons left">view_list</i>
                        Vista Righe
                    </a>
                    <a href="{{ url_for('ml.view_ml_dashboard', project_id=project.id) }}" 
                       class="btn waves-effect waves-light grey">
                        <i class="material-icons left">arrow_back</i>
                        Dashboard
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Prompt AI Scientifico -->
    <div class="row">
        <div class="col s12">
            <div class="card">
                <div class="card-content">
                    <span class="card-title">
                        <i class="material-icons left">psychology</i>
                        Prompt AI per Ricerca Scientifica
                    </span>
                    <div class="row">
                        <div class="input-field col s12">
                            <textarea id="scientific-prompt" class="materialize-textarea" placeholder="Inserisci qui il tuo prompt per l'analisi AI scientifica della colonna...">Analizza questa colonna dal punto di vista scientifico e fornisci etichette appropriate per la ricerca.</textarea>
                            <label for="scientific-prompt">Prompt Personalizzato AI</label>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col s12">
                            <button class="btn waves-effect waves-light orange" id="apply-ai-to-column">
                                <i class="material-icons left">auto_fix_high</i>
                                Applica AI a Tutta la Colonna
                            </button>
                            <button class="btn waves-effect waves-light blue" id="reset-prompt">
                                <i class="material-icons left">refresh</i>
                                Reset Prompt
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Lista valori della colonna -->
    <div class="row">
        <div class="col s12">
            <div class="card">
                <div class="card-content">
                    <span class="card-title">
                        <i class="material-icons left">format_list_numbered</i>
                        Valori della Colonna
                    </span>
                    
                    <div class="column-values-container" style="max-height: 60vh; overflow-y: auto;">
                        {% for value in column_data.all_values %}
                        {% set row_index = loop.index0 %}
                        <div class="card column-value-card" data-row-index="{{ row_index }}" data-value="{{ value }}"
                             style="margin: 10px 0; cursor: pointer; transition: all 0.3s;">
                            <div class="card-content" style="padding: 15px;">
                                <div class="row valign-wrapper" style="margin-bottom: 0;">
                                    <div class="col s2">
                                        <div class="center-align">
                                            <span class="badge blue white-text">Riga {{ row_index }}</span>
                                        </div>
                                    </div>
                                    <div class="col s7">
                                        <div class="cell-content">
                                            <span class="cell-value" style="font-size: 1.1em; font-weight: 500; color: #212121;">
                                                {{ value if value else '(vuoto)' }}
                                            </span>
                                            {% if applied_labels.get(row_index) %}
                                            <div style="margin-top: 8px;">
                                                <span class="chip green white-text">
                                                    {{ applied_labels[row_index].label_name }}
                                                </span>
                                                {% if applied_labels[row_index].confidence %}
                                                <span class="badge orange white-text">{{ "%.1f"|format(applied_labels[row_index].confidence * 100) }}%</span>
                                                {% endif %}
                                            </div>
                                            {% endif %}
                                        </div>
                                    </div>
                                    <div class="col s3">
                                        <div class="center-align">
                                            <button class="btn-small waves-effect waves-light blue label-cell-btn"
                                                    data-row="{{ row_index }}" data-column="{{ selected_column }}" data-value="{{ value }}">
                                                <i class="material-icons">label</i>
                                            </button>
                                            <button class="btn-small waves-effect waves-light orange ai-suggest-btn"
                                                    data-row="{{ row_index }}" data-column="{{ selected_column }}" data-value="{{ value }}">
                                                <i class="material-icons">psychology</i>
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                        
                        {% if column_data.all_values|length == 0 %}
                        <div class="center-align" style="padding: 40px;">
                            <i class="material-icons large grey-text">info</i>
                            <p class="grey-text">Nessun dato trovato in questa colonna</p>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal per Etichettatura Cella -->
<div id="label-cell-modal" class="modal">
    <div class="modal-content">
        <h4>Etichetta Cella</h4>
        <div class="row">
            <div class="col s12">
                <div class="card-panel grey lighten-4">
                    <p><strong>Posizione:</strong> Riga <span id="modal-row"></span>, Colonna <span id="modal-column"></span></p>
                    <p><strong>Valore:</strong> <span id="modal-value"></span></p>
                </div>
            </div>
        </div>
        
        <form id="label-cell-form">
            <div class="row">
                <div class="input-field col s12">
                    <input id="cell-label-name" type="text" required>
                    <label for="cell-label-name">Nome Etichetta</label>
                </div>
            </div>
            <div class="row">
                <div class="input-field col s12">
                    <textarea id="cell-label-description" class="materialize-textarea"></textarea>
                    <label for="cell-label-description">Descrizione Etichetta</label>
                </div>
            </div>
        </form>
    </div>
    <div class="modal-footer">
        <a href="#!" class="modal-close waves-effect waves-green btn-flat">Annulla</a>
        <a href="#!" class="waves-effect waves-green btn" id="save-cell-label-btn">Salva Etichetta</a>
    </div>
</div>

<!-- Modal per Suggerimento AI -->
<div id="ai-suggestion-modal" class="modal">
    <div class="modal-content">
        <h4>Suggerimento AI</h4>
        <div class="progress" id="ai-progress" style="display: none;">
            <div class="indeterminate"></div>
        </div>
        <div id="ai-suggestion-content" style="display: none;">
            <div class="card-panel blue lighten-4">
                <h6>Suggerimento AI:</h6>
                <p id="ai-suggested-label"></p>
                <p id="ai-suggested-description"></p>
            </div>
        </div>
    </div>
    <div class="modal-footer">
        <a href="#!" class="modal-close waves-effect waves-green btn-flat">Chiudi</a>
        <a href="#!" class="waves-effect waves-green btn" id="accept-ai-suggestion-btn" style="display: none;">
            Accetta Suggerimento
        </a>
    </div>
</div>

<style>
/* Assicura sfondo bianco e testo scuro */
body {
    background-color: #ffffff !important;
    color: #212121 !important;
}

.container, .container-fluid {
    background-color: #ffffff !important;
}

.card, .card-content, .card-panel {
    background-color: #ffffff !important;
    color: #212121 !important;
}

.column-value-card:hover {
    box-shadow: 0 8px 17px 0 rgba(0,0,0,0.2),0 6px 20px 0 rgba(0,0,0,0.19) !important;
    transform: translateY(-2px);
}

.column-value-card.labeled {
    border-left: 4px solid #4caf50;
    background-color: #f8fff8 !important;
}

.cell-value {
    word-wrap: break-word;
    line-height: 1.4;
    color: #212121 !important;
    background-color: #f5f5f5;
    padding: 8px;
    border-radius: 4px;
}

.grey-text {
    color: #616161 !important;
}

.blue-text {
    color: #1976d2 !important;
    font-weight: bold;
}

.green-text {
    color: #388e3c !important;
    font-weight: bold;
}

.orange-text {
    color: #f57c00 !important;
    font-weight: bold;
}

.purple-text {
    color: #7b1fa2 !important;
    font-weight: bold;
}

.card-title, .breadcrumb, h4, h5, h6, p, span {
    color: #212121 !important;
}

.modal, .modal-content, .modal-footer {
    background-color: #ffffff !important;
    color: #212121 !important;
}

.nav-wrapper {
    background-color: #2196f3 !important;
}

.nav-wrapper .breadcrumb {
    color: #ffffff !important;
}

.badge {
    color: #ffffff !important;
}

/* Migliora la leggibilità degli input */
input[type=text], input[type=email], input[type=password], textarea {
    color: #212121 !important;
    background-color: #ffffff !important;
    border-bottom: 1px solid #9e9e9e !important;
}

input[type=text]:focus, input[type=email]:focus, input[type=password]:focus, textarea:focus {
    border-bottom: 2px solid #2196f3 !important;
    box-shadow: 0 1px 0 0 #2196f3 !important;
}

label {
    color: #757575 !important;
}

label.active {
    color: #2196f3 !important;
}

/* Fix per i chip */
.chip {
    background-color: #e0e0e0 !important;
    color: #212121 !important;
}

.chip.green {
    background-color: #4caf50 !important;
    color: #ffffff !important;
}

.chip.blue {
    background-color: #2196f3 !important;
    color: #ffffff !important;
}

.chip.orange {
    background-color: #ff9800 !important;
    color: #ffffff !important;
}

.column-values-container {
    background-color: #fafafa !important;
    border: 1px solid #e0e0e0;
    border-radius: 4px;
    padding: 10px;
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Inizializza modal
    M.Modal.init(document.querySelectorAll('.modal'));
    M.updateTextFields();
    
    let currentCell = null;
    
    // Evidenzia celle etichettate
    document.querySelectorAll('.column-value-card').forEach(card => {
        const rowIndex = card.dataset.rowIndex;
        if (document.querySelector(`[data-row-index="${rowIndex}"] .chip`)) {
            card.classList.add('labeled');
        }
    });
    
    // Gestisci click su cella per etichettare
    document.querySelectorAll('.label-cell-btn').forEach(btn => {
        btn.addEventListener('click', function(e) {
            e.stopPropagation();
            currentCell = this;
            const row = this.dataset.row;
            const column = this.dataset.column;
            const value = this.dataset.value;
            
            // Popola modal
            document.getElementById('modal-row').textContent = row;
            document.getElementById('modal-column').textContent = column;
            document.getElementById('modal-value').textContent = value || '(vuoto)';
            
            // Reset campi
            document.getElementById('cell-label-name').value = '';
            document.getElementById('cell-label-description').value = '';
            M.updateTextFields();
            
            const modal = M.Modal.getInstance(document.getElementById('label-cell-modal'));
            modal.open();
        });
    });
    
    // Gestisci suggerimento AI per singola cella
    document.querySelectorAll('.ai-suggest-btn').forEach(btn => {
        btn.addEventListener('click', function(e) {
            e.stopPropagation();
            currentCell = this;
            const value = this.dataset.value;
            const column = this.dataset.column;
            
            if (!value || value === 'None') {
                M.toast({html: 'Impossibile analizzare celle vuote', classes: 'orange'});
                return;
            }
            
            const aiModal = M.Modal.getInstance(document.getElementById('ai-suggestion-modal'));
            const progress = document.getElementById('ai-progress');
            const content = document.getElementById('ai-suggestion-content');
            const acceptBtn = document.getElementById('accept-ai-suggestion-btn');
            
            progress.style.display = 'block';
            content.style.display = 'none';
            acceptBtn.style.display = 'none';
            
            aiModal.open();
            
            // Simula analisi AI (sostituire con vera chiamata API)
            setTimeout(() => {
                const prompt = document.getElementById('scientific-prompt').value;
                let suggestedLabel = 'Contenuto Analizzato';
                let suggestedDescription = 'Contenuto classificato attraverso analisi AI';
                
                // Logica simulata basata sul contenuto
                if (value.toLowerCase().includes('positiv') || value.toLowerCase().includes('buon') || value.toLowerCase().includes('ottim')) {
                    suggestedLabel = 'Sentiment Positivo';
                    suggestedDescription = 'Contenuto con valutazione positiva identificato dall\'AI';
                } else if (value.toLowerCase().includes('negativ') || value.toLowerCase().includes('cattiv') || value.toLowerCase().includes('pessim')) {
                    suggestedLabel = 'Sentiment Negativo';
                    suggestedDescription = 'Contenuto con valutazione negativa identificato dall\'AI';
                } else if (value.match(/\d+/)) {
                    suggestedLabel = 'Valore Numerico';
                    suggestedDescription = 'Contenuto numerico identificato dall\'AI';
                } else if (value.length > 50) {
                    suggestedLabel = 'Testo Lungo';
                    suggestedDescription = 'Contenuto testuale esteso identificato dall\'AI';
                }
                
                document.getElementById('ai-suggested-label').textContent = suggestedLabel;
                document.getElementById('ai-suggested-description').textContent = suggestedDescription;
                
                progress.style.display = 'none';
                content.style.display = 'block';
                acceptBtn.style.display = 'inline-block';
            }, 2000);
        });
    });
    
    // Salva etichetta cella
    document.getElementById('save-cell-label-btn').addEventListener('click', function() {
        if (!currentCell) return;
        
        const data = {
            row_index: currentCell.dataset.row,
            column_name: currentCell.dataset.column,
            label_name: document.getElementById('cell-label-name').value,
            label_description: document.getElementById('cell-label-description').value
        };
        
        fetch('{{ url_for("ml.label_cell_manually", project_id=project.id, sheet_id=sheet.id) }}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(data)
        })
        .then(response => response.json())
        .then(data => {
            if (data.message) {
                M.toast({html: data.message, classes: 'green'});
                const modal = M.Modal.getInstance(document.getElementById('label-cell-modal'));
                modal.close();
                location.reload();
            } else {
                M.toast({html: data.error || 'Errore nell\'etichettatura', classes: 'red'});
            }
        })
        .catch(error => {
            M.toast({html: 'Errore di rete: ' + error.message, classes: 'red'});
        });
    });
    
    // Accetta suggerimento AI
    document.getElementById('accept-ai-suggestion-btn').addEventListener('click', function() {
        const suggestedLabel = document.getElementById('ai-suggested-label').textContent;
        const suggestedDescription = document.getElementById('ai-suggested-description').textContent;
        
        document.getElementById('cell-label-name').value = suggestedLabel;
        document.getElementById('cell-label-description').value = suggestedDescription;
        M.updateTextFields();
        
        const aiModal = M.Modal.getInstance(document.getElementById('ai-suggestion-modal'));
        aiModal.close();
        
        const labelModal = M.Modal.getInstance(document.getElementById('label-cell-modal'));
        labelModal.open();
        
        M.toast({html: 'Suggerimento AI applicato!', classes: 'blue'});
    });
    
    // Applica AI a tutta la colonna
    document.getElementById('apply-ai-to-column').addEventListener('click', function() {
        const prompt = document.getElementById('scientific-prompt').value;
        if (!prompt.trim()) {
            M.toast({html: 'Inserisci un prompt AI prima di procedere', classes: 'orange'});
            return;
        }
        
        M.toast({html: 'Applicazione AI a tutta la colonna in corso...', classes: 'blue'});
        
        // Simulazione (sostituire con vera chiamata batch)
        setTimeout(() => {
            M.toast({html: 'Analisi AI completata per tutti i valori della colonna!', classes: 'green'});
        }, 3000);
    });
    
    // Reset prompt
    document.getElementById('reset-prompt').addEventListener('click', function() {
        document.getElementById('scientific-prompt').value = 'Analizza questa colonna dal punto di vista scientifico e fornisci etichette appropriate per la ricerca.';
        M.updateTextFields();
        M.toast({html: 'Prompt resettato', classes: 'blue'});
    });
});
</script>
{% endblock %}
